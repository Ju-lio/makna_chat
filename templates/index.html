<!DOCTYPE html>
<html>
  <head>
    <title>{% if room %}{{ room.name }}{% else %}Chat{% endif %}</title>
    <meta charset="UTF-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <audio id="notificationSound" preload="auto">
      <source
        src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        type="audio/mp3"
      />
    </audio>
    <style>
      html,
      body {
        font-family: Segoe UI, Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #252526;
        color: #ffffff;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .menubar {
        background-color: #333333;
        padding: 2px 8px;
        border-bottom: 1px solid #3d3d3d;
        font-size: 12px;
      }
      .menubar span {
        color: #cccccc;
        padding: 4px 8px;
        cursor: default;
      }
      .menubar span:hover {
        background-color: #3d3d3d;
      }
      .toolbar {
        background-color: #2d2d2d;
        padding: 4px 8px;
        border-bottom: 1px solid #3d3d3d;
        display: flex;
        gap: 4px;
        justify-content: space-between;
        align-items: center;
      }
      .toolbar-left {
        display: flex;
        gap: 4px;
      }
      .toolbar button {
        background: transparent;
        border: none;
        color: #cccccc;
        padding: 2px 8px;
        font-size: 12px;
        cursor: pointer;
      }
      .toolbar button:hover {
        background-color: #3d3d3d;
      }
      .logout-btn {
        background-color: #3c3c3c !important;
        color: #858585 !important;
        padding: 4px 12px !important;
        border-radius: 2px;
        font-size: 11px !important;
        transition: all 0.2s;
        border: 1px solid #505050 !important;
      }
      .logout-btn:hover {
        background-color: #505050 !important;
        color: #cccccc !important;
        border-color: #606060 !important;
      }
      .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      .sidebar {
        width: 250px;
        background-color: #252526;
        border-right: 1px solid #3d3d3d;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .sidebar.minimized {
        width: 48px;
      }
      .sidebar.minimized .sidebar-content {
        opacity: 0;
        pointer-events: none;
      }
      .sidebar.minimized .room-name {
        display: none;
      }
      .sidebar.minimized .sidebar-header {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        padding: 12px 8px;
      }
      .sidebar-header {
        padding: 8px;
        font-size: 11px;
        color: #cccccc;
        background-color: #2d2d2d;
        border-bottom: 1px solid #3d3d3d;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
      }
      .sidebar-toggle {
        background: transparent;
        border: none;
        color: #cccccc;
        cursor: pointer;
        padding: 4px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
        border-radius: 3px;
      }
      .sidebar-toggle:hover {
        background-color: #3d3d3d;
      }
      .sidebar-content {
        padding: 4px;
        flex: 1;
        font-size: 12px;
        color: #cccccc;
        overflow-y: auto;
        transition: opacity 0.3s ease;
      }
      .room-item {
        padding: 8px 12px;
        margin: 2px 0;
        cursor: pointer;
        border-radius: 3px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
        white-space: nowrap;
        overflow: hidden;
      }
      .room-item:hover {
        background-color: #2d2d2d;
      }
      .room-item.active {
        background-color: #094771;
        color: #ffffff;
      }
      .room-icon {
        font-size: 16px;
      }
      .room-name {
        font-size: 12px;
        transition: opacity 0.2s ease;
      }
      .sidebar.minimized .room-item {
        justify-content: center;
        padding: 8px;
      }
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }
      .tab-bar {
        background-color: #2d2d2d;
        border-bottom: 1px solid #3d3d3d;
        display: flex;
        padding: 0 4px;
        overflow-x: auto;
        overflow-y: hidden;
      }
      .tab {
        padding: 6px 16px;
        background-color: #2d2d2d;
        border-right: 1px solid #3d3d3d;
        border-top: 2px solid transparent;
        font-size: 12px;
        color: #969696;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
      }
      .tab:hover {
        background-color: #383838;
        color: #ffffff;
      }
      .tab.active {
        background-color: #1e1e1e;
        color: #ffffff;
        border-top-color: #007acc;
      }
      .tab .close-tab {
        margin-left: 4px;
        color: #858585;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        padding: 0 4px;
      }
      .tab .close-tab:hover {
        color: #ffffff;
        background-color: #e81123;
        border-radius: 2px;
      }
      .tab.room-tab .close-tab {
        display: none; /* N√£o pode fechar a aba da sala */
      }
      .hidden-badge {
        background-color: #5a5a5a;
        color: #ffffff;
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
        text-transform: uppercase;
      }
      #chat-container {
        flex: 1;
        overflow-y: auto;
        background-color: #1e1e1e;
        font-family: Consolas, monospace;
        font-size: 12px;
        padding: 0;
      }
      .message {
        padding: 4px 8px;
        border-bottom: 1px solid #2d2d2d;
        color: #303030;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .message:hover {
        background-color: #2d2d2d;
        color: #d4d4d4;
      }
      .message.new-message .message-content span {
        animation: glowText 0.8s ease-out;
      }
      @keyframes glowText {
        0% {
          color: #d4d4d4;
          text-shadow: 0 0 5px #00d4ff, 0 0 10px #007acc;
        }
        50% {
          color: #ffffff;
          text-shadow: 0 0 10px #00d4ff, 0 0 20px #00d4ff, 0 0 30px #007acc;
        }
        100% {
          color: inherit;
          text-shadow: none;
        }
      }
      .message-number {
        color: #303030;
        min-width: 40px;
        text-align: right;
        padding-right: 8px;
        user-select: none;
      }
      .message:hover .message-number {
        color: #858585;
      }
      .message-content {
        flex: 1;
        white-space: pre-wrap;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .status-bar {
        background-color: #007acc;
        padding: 2px 8px;
        font-size: 12px;
        color: white;
        display: flex;
        justify-content: space-between;
      }
      .typing-indicator {
        background-color: #252526;
        padding: 2px 16px;
        font-size: 9px;
        color: #858585;
        font-style: italic;
        min-height: 14px;
        display: flex;
        align-items: center;
        border-top: 1px solid #3d3d3d;
      }
      .typing-indicator.hidden #typing-text {
        visibility: hidden;
      }
      .typing-indicator.hidden .typing-dots {
        visibility: hidden;
      }
      .typing-dots {
        display: inline-block;
        margin-left: 4px;
      }
      .typing-dots span {
        animation: blink 1.4s infinite;
        animation-fill-mode: both;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes blink {
        0%,
        80%,
        100% {
          opacity: 0;
        }
        40% {
          opacity: 1;
        }
      }
      .user-input {
        background-color: #1e1e1e;
        padding: 8px;
        display: flex;
        gap: 8px;
        border-top: 1px solid #3d3d3d;
      }
      #message-input {
        flex: 1;
        padding: 4px 8px;
        background-color: #3c3c3c;
        border: 1px solid #3d3d3d;
        color: #d4d4d4;
        font-family: Consolas, monospace;
        font-size: 12px;
      }
      #message-input:focus {
        outline: none;
        border-color: #007acc;
      }
      /* Estilo para todos os inputs de mensagem */
      .user-input input[type='text'] {
        flex: 1;
        padding: 4px 8px;
        background-color: #3c3c3c;
        border: 1px solid #3d3d3d;
        color: #d4d4d4;
        font-family: Consolas, monospace;
        font-size: 12px;
      }
      .user-input input[type='text']:focus {
        outline: none;
        border-color: #007acc;
      }
      button.send {
        padding: 4px 12px;
        background-color: transparent;
        color: #cccccc;
        border: 1px solid #3d3d3d;
        cursor: pointer;
        font-size: 12px;
      }
      button.send:hover {
        background-color: #2d2d2d;
      }
      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 14px;
      }
      ::-webkit-scrollbar-track {
        background: #1e1e1e;
      }
      ::-webkit-scrollbar-thumb {
        background: #424242;
        border: 3px solid #1e1e1e;
        border-radius: 7px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #4f4f4f;
      }
      .username {
        color: #303030;
        transition: color 0.3s ease;
      }
      .message:hover .username {
        color: #4ec9b0;
      }
      .timestamp {
        color: #303030;
        transition: color 0.3s ease;
      }
      .message:hover .timestamp {
        color: #858585;
      }
      .private-indicator {
        color: #ff6666;
        font-weight: bold;
        margin-left: 10px;
      }

      .username {
        cursor: pointer;
      }
      .username:hover {
        text-decoration: underline;
      }

      /* Estilo para chats privados dentro das abas */
      .chat-view {
        display: none;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }
      .chat-view.active {
        display: flex;
      }

      /* Design Responsivo para Mobile */
      @media (max-width: 768px) {
        body {
          background-color: #1e1e1e;
        }

        .menubar,
        .toolbar {
          display: none; /* Esconde elementos n√£o essenciais em mobile */
        }

        .sidebar {
          display: none; /* Esconde a sidebar em mobile */
        }

        .main-container {
          flex-direction: column;
          background-color: #1e1e1e;
        }

        .content {
          width: 100%;
          background-color: #1e1e1e;
        }

        #chat-container {
          background-color: #1e1e1e;
        }

        /* Modal responsivo em mobile */
        .private-chat-modal {
          width: 95%;
          height: 90%;
          max-width: 500px;
        }

        .private-chat-header h3 {
          font-size: 13px;
        }

        .private-message {
          max-width: 85%;
        }

        .private-chat-input-container input {
          font-size: 16px; /* Evita zoom no iOS */
        }

        .message {
          padding: 8px;
          font-size: 14px;
          background-color: transparent;
          border-bottom: 1px solid #2d2d2d;
          color: #d4d4d4;
        }

        .message:hover {
          background-color: #2d2d2d;
        }

        .message.selected {
          background-color: #094771;
          color: #ffffff;
        }

        .message-content {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }

        .username {
          color: #4ec9b0 !important;
          font-weight: bold;
          font-size: 14px;
        }

        .timestamp {
          font-size: 11px;
          color: #858585 !important;
        }

        .message-text {
          color: #d4d4d4;
        }

        .message.selected .message-text {
          color: #ffffff;
        }

        .user-input {
          padding: 12px;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: #1e1e1e;
          border-top: 1px solid #3d3d3d;
        }

        #message-input {
          height: 40px;
          font-size: 16px;
          padding: 8px 12px;
        }

        button.send {
          padding: 8px 16px;
          font-size: 14px;
          min-width: 80px;
        }

        #chat-container {
          margin-bottom: 8px; /* Espa√ßo para o input fixo */
          padding-bottom: 30px;
          height: calc(100vh - 80px);
          overflow-y: auto;
        }

        .chat-messages {
          padding-bottom: 20px;
        }

        .status-bar {
          display: none; /* Esconde a barra de status em mobile */
        }

        /* Ajustes para telas muito pequenas */
        @media (max-width: 380px) {
          .message-number {
            display: none; /* Esconde n√∫meros em telas muito pequenas */
          }

          .message {
            padding: 6px;
            font-size: 13px;
          }

          #message-input {
            font-size: 14px;
          }
        }

        /* Ajustes para orienta√ß√£o paisagem */
        @media (orientation: landscape) {
          #chat-container {
            height: calc(100vh - 100px);
            margin-bottom: 70px;
          }

          .user-input {
            height: 60px;
          }
        }

        /* For√ßa scroll suave e visibilidade da √∫ltima mensagem */
        #chat-container {
          scroll-behavior: smooth;
        }

        .message:last-child {
          margin-bottom: 20px;
        }
      }
    </style>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
  </head>
  <body>
    <div class="menubar">
      <span>Arquivo</span>
      <span>Editar</span>
      <span>Visualizar</span>
      <span>Projeto</span>
      <span>Depurar</span>
      <span>Ferramentas</span>
      <span>Ajuda</span>
    </div>
    <div class="toolbar">
      <div class="toolbar-left">
        <button>‚ñ∂ Executar</button>
        <button>‚è∏ Pausar</button>
        <button>‚èπ Parar</button>
        <button>‚Üª Reiniciar</button>
      </div>
      <button class="logout-btn" onclick="logout()" title="Sair do chat">
        üö™ Sair
      </button>
    </div>
    <div class="main-container">
      <div class="sidebar minimized" id="sidebar">
        <div class="sidebar-header">
          <span>SALAS DE CHAT</span>
          <button
            class="sidebar-toggle"
            onclick="toggleSidebar()"
            title="Minimizar/Expandir"
          >
            <span id="toggle-icon">‚ñ∂</span>
          </button>
        </div>
        <div class="sidebar-content">
          {% if rooms %} {% for r in rooms %} {% if not r.hidden %}
          <div
            class="room-item {% if room and room.id == r.id %}active{% endif %}"
            onclick="location.href='{{ r.url }}'"
          >
            <span class="room-icon">{{ r.icon }}</span>
            <span class="room-name">{{ r.name }}</span>
          </div>
          {% endif %} {% endfor %} {% else %}
          <div style="color: #858585">Nenhuma sala dispon√≠vel</div>
          {% endif %}
        </div>
      </div>
      <div class="content">
        <div class="tab-bar" id="tab-bar">
          <div class="tab active room-tab" data-tab="room">
            <span>
              {% if room %} {{ room.icon }} {{ room.name }} {% else %} Console
              de Depura√ß√£o {% endif %}
            </span>
            {% if room and room.hidden %}
            <span class="hidden-badge">üîí Oculta</span>
            {% endif %}
          </div>
        </div>

        <!-- Chat da sala p√∫blica -->
        <div class="chat-view active" id="chat-room">
          <div id="chat-container"></div>
          <div id="typing-indicator" class="typing-indicator">
            <span id="typing-text"></span>
            <span class="typing-dots">
              <span>.</span><span>.</span><span>.</span>
            </span>
          </div>
          <div class="user-input">
            <input
              type="text"
              id="message-input"
              placeholder="Digite uma mensagem..."
            />
            <button class="send" onclick="sendMessage()">Enviar</button>
          </div>
        </div>
      </div>
    </div>
    <div class="status-bar">
      <div>Conectado</div>
      <div>Terminal: 1</div>
      <div id="current-user"></div>
    </div>

    <script>
      let lastMessageCount = 0;
      let originalTitle = document.title;
      let isBlinking = false;
      let blinkInterval;
      let hoverTimeout;
      let isManuallyMinimized = true; // Inicia minimizado por padr√£o

      // Controle da sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const icon = document.getElementById('toggle-icon');

        sidebar.classList.toggle('minimized');
        isManuallyMinimized = sidebar.classList.contains('minimized');

        if (isManuallyMinimized) {
          icon.textContent = '‚ñ∂';
        } else {
          icon.textContent = '‚óÄ';
        }
      }

      // Hover na sidebar minimizada
      document.addEventListener('DOMContentLoaded', function () {
        const sidebar = document.getElementById('sidebar');

        sidebar.addEventListener('mouseenter', function () {
          if (sidebar.classList.contains('minimized')) {
            // Espera 500ms antes de expandir
            hoverTimeout = setTimeout(() => {
              sidebar.classList.remove('minimized');
              document.getElementById('toggle-icon').textContent = '‚óÄ';
            }, 500);
          }
        });

        sidebar.addEventListener('mouseleave', function () {
          // Cancela o timeout se sair antes dos 500ms
          clearTimeout(hoverTimeout);

          // Se foi minimizada manualmente, volta a minimizar ao sair
          if (isManuallyMinimized) {
            sidebar.classList.add('minimized');
            document.getElementById('toggle-icon').textContent = '‚ñ∂';
          }
        });

        // Adiciona click handler para a aba da sala
        const roomTab = document.querySelector('.room-tab');
        if (roomTab) {
          roomTab.addEventListener('click', function () {
            switchTab('room');
          });
        }
      });

      // Controle de digita√ß√£o
      let typingTimeout;
      let isCurrentlyTyping = false;

      function notifyTyping(isTyping) {
        const roomId = window.location.pathname.substring(1) || 'geral';
        const username = localStorage.getItem('chatUsername');

        fetch('/typing', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user: username,
            room_id: roomId,
            is_typing: isTyping,
          }),
        }).catch((error) =>
          console.error('Erro ao notificar digita√ß√£o:', error),
        );
      }

      function updateTypingIndicator() {
        const roomId = window.location.pathname.substring(1) || 'geral';
        const username = localStorage.getItem('chatUsername');

        fetch(`/typing?room_id=${roomId}&user=${username}`)
          .then((response) => response.json())
          .then((users) => {
            const indicator = document.getElementById('typing-indicator');
            const textEl = document.getElementById('typing-text');

            if (users.length > 0) {
              let text = '';
              if (users.length === 1) {
                text = `${users[0]} est√° digitando`;
              } else if (users.length === 2) {
                text = `${users[0]} e ${users[1]} est√£o digitando`;
              } else {
                text = `${users[0]}, ${users[1]} e mais ${
                  users.length - 2
                } est√£o digitando`;
              }
              textEl.textContent = text;
              indicator.classList.remove('hidden');
            } else {
              textEl.textContent = '';
              indicator.classList.add('hidden');
            }
          })
          .catch((error) =>
            console.error('Erro ao atualizar indicador:', error),
          );
      }

      // Fun√ß√£o simples para codificar a mensagem durante a transmiss√£o
      function encodeMessage(message) {
        return btoa(unescape(encodeURIComponent(message))); // Codifica para base64
      }

      // Fun√ß√£o para decodificar a mensagem recebida
      function decodeMessage(encodedMessage) {
        try {
          return decodeURIComponent(escape(atob(encodedMessage))); // Decodifica do base64
        } catch (e) {
          console.error('Erro ao decodificar:', e);
          return message;
        }
      }
      function startTitleBlinking() {
        if (!isBlinking) {
          isBlinking = true;
          let isOriginal = true;
          blinkInterval = setInterval(() => {
            document.title = isOriginal ? 'üîî Nova Mensagem!' : originalTitle;
            isOriginal = !isOriginal;
          }, 1000);
        }
      }

      function stopTitleBlinking() {
        if (isBlinking) {
          clearInterval(blinkInterval);
          document.title = originalTitle;
          isBlinking = false;
        }
      }

      function playNotificationSound() {
        const sound = document.getElementById('notificationSound');
        sound.volume = 0.2; // Reduzindo o volume para 20% do m√°ximo
        sound.currentTime = 0;
        sound.play().catch((e) => console.log('Erro ao tocar som:', e));
      }

      // Quando a janela recebe foco, para de piscar
      window.addEventListener('focus', stopTitleBlinking);

      // Fun√ß√£o de logout
      function logout() {
        if (confirm('Deseja realmente sair do chat?')) {
          localStorage.removeItem('chatUsername');
          window.location.href = '/logout';
        }
      }

      // Verifica se o usu√°rio est√° logado
      const username = localStorage.getItem('chatUsername');
      if (!username) {
        window.location.href = '/login';
      }

      // Atualiza o nome do usu√°rio na barra de status
      document.getElementById(
        'current-user',
      ).textContent = `Usu√°rio: ${username}`;

      function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();

        if (message) {
          // Codifica a mensagem para transmiss√£o segura
          const encodedMessage = encodeMessage(message);

          // Pega o room_id da URL atual
          const roomId = window.location.pathname.substring(1) || 'geral';

          fetch('/send', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              user: username,
              message: encodedMessage,
              room_id: roomId,
            }),
          })
            .then((response) => {
              if (response.status === 401) {
                localStorage.removeItem('chatUsername');
                window.location.href = '/login';
                return { status: 'error' };
              }
              return response.json();
            })
            .then((data) => {
              if (data.status === 'success') {
                messageInput.value = '';
              }
            })
            .catch((error) => console.error('Erro:', error));
        }
      }

      function updateChat() {
        // Pega o room_id da URL atual
        const roomId = window.location.pathname.substring(1) || 'geral';

        fetch(`/messages?room_id=${roomId}`)
          .then((response) => {
            if (response.status === 401) {
              // Sess√£o expirou, limpa localStorage e redireciona
              localStorage.removeItem('chatUsername');
              window.location.href = '/login';
              return [];
            }
            return response.json();
          })
          .then((messages) => {
            if (messages.length > lastMessageCount) {
              const chatContainer = document.getElementById('chat-container');

              // Se houver novas mensagens e a janela n√£o estiver em foco
              if (!document.hasFocus()) {
                startTitleBlinking();
                playNotificationSound();
              }

              chatContainer.innerHTML = '';
              messages.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';

                // Adiciona anima√ß√£o apenas para mensagens novas
                if (index >= lastMessageCount) {
                  messageDiv.classList.add('new-message');
                  // Remove a classe ap√≥s a anima√ß√£o terminar
                  setTimeout(() => {
                    messageDiv.classList.remove('new-message');
                  }, 800);
                }

                messageDiv.innerHTML = `
                    <div class="message-number">${index + 1}</div>
                    <div class="message-content">
                        <span class="username" ondblclick="openPrivateChat('${
                          msg.user
                        }')">${msg.user}</span>
                        <span class="timestamp">[${msg.timestamp}]:</span>
                        <span>${decodeMessage(msg.message)}</span>
                    </div>`;
                chatContainer.appendChild(messageDiv);
              });
              chatContainer.scrollTop = chatContainer.scrollHeight;
              lastMessageCount = messages.length;
            }
          });
      }

      // ========== SISTEMA DE CHAT PRIVADO COM ABAS ==========
      let privateTabs = {}; // Armazena dados das abas privadas { username: { interval, lastCount } }
      let activeTab = 'room'; // Aba ativa atual

      function switchTab(tabId) {
        // Remove active de todas as abas e views
        document
          .querySelectorAll('.tab')
          .forEach((tab) => tab.classList.remove('active'));
        document
          .querySelectorAll('.chat-view')
          .forEach((view) => view.classList.remove('active'));

        // Ativa a aba e view selecionadas
        const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if (tab) {
          tab.classList.add('active');
          activeTab = tabId;

          if (tabId === 'room') {
            document.getElementById('chat-room').classList.add('active');
          } else {
            const privateView = document.getElementById(
              `chat-private-${tabId}`,
            );
            if (privateView) {
              privateView.classList.add('active');
              // Scroll para o final ao abrir
              const container = privateView.querySelector('.private-messages');
              if (container) {
                container.scrollTop = container.scrollHeight;
              }
            }
          }
        }
      }

      function openPrivateChat(username) {
        const currentUser = localStorage.getItem('username');
        if (username === currentUser) {
          return; // N√£o abre chat consigo mesmo
        }

        // Se a aba j√° existe, apenas ativa
        if (privateTabs[username]) {
          switchTab(username);
          return;
        }

        // Cria nova aba
        const tabBar = document.getElementById('tab-bar');
        const newTab = document.createElement('div');
        newTab.className = 'tab';
        newTab.setAttribute('data-tab', username);
        newTab.innerHTML = `
          <span>üí¨ ${username}</span>
          <span class="close-tab" onclick="closePrivateTab('${username}', event)">√ó</span>
        `;
        newTab.onclick = () => switchTab(username);
        tabBar.appendChild(newTab);

        // Cria view do chat privado
        const content = document.querySelector('.content');
        const chatView = document.createElement('div');
        chatView.className = 'chat-view';
        chatView.id = `chat-private-${username}`;
        chatView.innerHTML = `
          <div class="private-messages" id="private-messages-${username}" style="
            flex: 1;
            overflow-y: auto;
            background-color: #1e1e1e;
            padding: 0;
            font-family: Consolas, monospace;
            font-size: 12px;
          "></div>
          <div class="user-input">
            <input
              type="text"
              id="private-input-${username}"
              placeholder="Mensagem para ${username}..."
              onkeypress="if(event.key==='Enter') sendPrivateMessage('${username}')"
            />
            <button class="send" onclick="sendPrivateMessage('${username}')">Enviar</button>
          </div>
        `;
        content.appendChild(chatView);

        // Inicializa dados da aba
        privateTabs[username] = {
          interval: setInterval(() => loadPrivateMessages(username), 2000),
          lastCount: 0,
        };

        // Carrega mensagens e ativa a aba
        loadPrivateMessages(username);
        switchTab(username);
      }

      function closePrivateTab(username, event) {
        event.stopPropagation(); // Evita ativar a aba ao fechar

        // Para o intervalo de atualiza√ß√£o
        if (privateTabs[username] && privateTabs[username].interval) {
          clearInterval(privateTabs[username].interval);
        }
        delete privateTabs[username];

        // Remove a aba
        const tab = document.querySelector(`.tab[data-tab="${username}"]`);
        if (tab) tab.remove();

        // Remove a view
        const view = document.getElementById(`chat-private-${username}`);
        if (view) view.remove();

        // Se era a aba ativa, volta para a sala
        if (activeTab === username) {
          switchTab('room');
        }
      }

      function loadPrivateMessages(username) {
        const currentUser = localStorage.getItem('username');

        fetch(`/messages-private/${username}`)
          .then((response) => {
            if (response.status === 401) {
              localStorage.removeItem('username');
              window.location.href = '/login';
              return;
            }
            return response.json();
          })
          .then((messages) => {
            const container = document.getElementById(
              `private-messages-${username}`,
            );
            if (!container) return;

            const wasAtBottom =
              container.scrollHeight - container.scrollTop <=
              container.clientHeight + 50;

            const lastCount = privateTabs[username].lastCount || 0;

            container.innerHTML = '';

            messages.forEach((msg, index) => {
              const msgDiv = document.createElement('div');
              msgDiv.className = 'message';

              // Adiciona anima√ß√£o apenas para mensagens novas
              if (index >= lastCount) {
                msgDiv.classList.add('new-message');
                setTimeout(() => {
                  msgDiv.classList.remove('new-message');
                }, 800);
              }

              const isFromCurrentUser = msg.from === currentUser;

              msgDiv.innerHTML = `
                <div class="message-number">${index + 1}</div>
                <div class="message-content">
                  <span class="username">${msg.from}</span>
                  <span class="timestamp">[${msg.timestamp}]:</span>
                  <span>${msg.message}</span>
                </div>
              `;

              container.appendChild(msgDiv);
            });

            // Auto-scroll se estava no final ou √© primeira carga
            if (wasAtBottom || !privateTabs[username].lastCount) {
              container.scrollTop = container.scrollHeight;
            }

            privateTabs[username].lastCount = messages.length;
          })
          .catch((error) => {
            console.error('Erro ao carregar mensagens privadas:', error);
          });
      }

      function sendPrivateMessage(username) {
        const input = document.getElementById(`private-input-${username}`);
        const message = input.value.trim();

        if (!message) return;

        fetch('/send-private', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            to_user: username,
            message: message,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'success') {
              input.value = '';
              loadPrivateMessages(username);
            } else {
              console.error('Erro ao enviar mensagem:', data.message);
            }
          })
          .catch((error) => {
            console.error('Erro ao enviar mensagem:', error);
          });
      }
      // ========== FIM DO SISTEMA DE CHAT PRIVADO ==========

      // Atualiza o chat a cada 2 segundos (reduzido para economizar requisi√ß√µes)
      setInterval(updateChat, 2000);

      // Atualiza o indicador de digita√ß√£o a cada 3 segundos (otimizado)
      setInterval(updateTypingIndicator, 3000); // Detecta quando usu√°rio est√° digitando
      const messageInput = document.getElementById('message-input');

      messageInput.addEventListener('input', function () {
        if (!isCurrentlyTyping) {
          isCurrentlyTyping = true;
          notifyTyping(true);
        }

        // Reinicia o timeout
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          isCurrentlyTyping = false;
          notifyTyping(false);
        }, 2000);
      });

      // Permite enviar mensagem com Enter
      messageInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          sendMessage();
          // Para de indicar que est√° digitando ao enviar
          clearTimeout(typingTimeout);
          isCurrentlyTyping = false;
          notifyTyping(false);
        }
      });
    </script>
  </body>
</html>
